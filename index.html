<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CALIDUS Connect</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<style>
  :root{
    --blue:#1674AF; --grey:#737371; --text:#222; --bg:#f2f4f7;
    --field:#fff; --field-border:#cfd3d8; --shadow:0 6px 24px rgba(0,0,0,.08);
    --ok:#0a7a2a; --warn:#b85c00; --muted:#6b7280; --danger:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:Bahnschrift,"Bahnschrift Regular","Segoe UI",Arial,sans-serif;font-size:10pt;line-height:1.45;color:var(--text)}
  .frame{min-height:100%;padding:24px}
  .sheet{position:relative;background:#fff;border:6px solid #2b2b2b;border-radius:4px;min-height:calc(100vh - 48px);overflow:hidden;display:flex;flex-direction:column}
  .sheet::before{content:"";position:absolute;inset:0;background:url("G5_BG.png") center/cover no-repeat;opacity:.08;pointer-events:none;z-index:0}
  .content{position:relative;z-index:2;padding:42px 48px 40px;flex:1;display:flex;flex-direction:column}
  .logo{position:absolute;top:16px;right:20px;height:100px;width:auto;z-index:3}
  @media (max-width:1024px){ .logo{height:80px} }
  .title{font-size:14pt;font-weight:700;margin:0 0 12px}
  .blue{color:var(--blue)}
  .intro{max-width:980px;margin-bottom:18px}
  .intro p{margin:0 0 8px}

  /* Home tiles */
  .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr);max-width:980px}
  @media (max-width:1180px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .tile{background:var(--field);border:1px solid var(--field-border);border-radius:16px;padding:18px;box-shadow:var(--shadow);text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:10px;min-height:140px;cursor:pointer;transition:transform .08s ease, box-shadow .12s ease;}
  .tile:hover{box-shadow:0 8px 28px rgba(0,0,0,.12);transform:translateY(-1px)}
  .tile h2{margin:0;font-size:12pt}
  .tile small{color:var(--muted)}
  .cta{margin-top:auto;background:var(--blue);color:#fff;border-radius:10px;padding:10px 14px;width:max-content;font-weight:700}

  /* Forms / layout */
  form{max-width:980px}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .grid2 .full{grid-column:1 / -1}
  @media (max-width:980px){ .grid2{grid-template-columns:1fr} }
  input,select,textarea{width:100%;background:#fff;border:1px solid var(--field-border);border-radius:12px;padding:12px 14px;font-size:10pt;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(22,116,175,.15)}
  textarea{resize:none;min-height:100px}
  .row{display:flex;align-items:center;gap:16px;flex-wrap:wrap;padding:6px 0}
  .row label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .row input[type="radio"], .row input[type="checkbox"]{width:16px;height:16px}
  .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .btn{appearance:none;border:0;cursor:pointer;font-size:10pt;font-weight:700;padding:12px 18px;border-radius:10px;box-shadow:var(--shadow);text-decoration:none;display:inline-flex;align-items:center}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-ghost{background:#e7eaee;color:#2d2d2d;border:1px solid #d5d8dc}
  .btnDanger{background:#ffe8e8;border:1px solid #ffd0d0}
  .link{color:var(--blue);text-decoration:underline;cursor:pointer}
  .section{display:none}
  .section.active{display:block}
  .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:var(--ok);color:#fff;padding:10px 16px;border-radius:999px;display:none;z-index:20;box-shadow:var(--shadow)}

  /* Hidden Admin Overlay */
  #hotspot{position:fixed;top:0;right:0;width:80px;height:80px;z-index:15}
  #admin{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:30}
  .panel{background:#fff;border-radius:14px;max-width:820px;width:100%;padding:20px;box-shadow:var(--shadow)}
  .panel h2{margin:0 0 8px;font-size:12pt}
  .panel p{margin:4px 0 14px;color:#444}
  .admin-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .admin-row{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--field-border);border-radius:12px;padding:10px 12px;background:#fff}
  .admin-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-secondary{background:#f1f3f5;border:1px solid #dde1e6;color:#222}

  /* Lists */
  .list{margin-top:14px;max-width:980px}
  .item{display:grid;grid-template-columns:1fr 120px 140px 120px 90px 90px;gap:10px;border:1px solid var(--field-border);border-radius:12px;padding:10px 12px;align-items:center;margin-bottom:8px;background:#fff}
  .item small{color:var(--muted)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700}
  .badge.open{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
  .badge.done{background:#eaffef;color:#065f46;border:1px solid #bbf7d0}
  .badge.pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .muted{color:var(--muted)}
  .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .pill{padding:6px 10px;border:1px solid var(--field-border);border-radius:999px;cursor:pointer;user-select:none}
  .pill.active{background:#e6f0f7;border-color:#b7d3ea}
  .warn{color:var(--warn);font-weight:700}
  .danger{color:var(--danger);font-weight:700}
  @media (max-width:980px){
    .item{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
  }
</style>
</head>
<body>
<div id="hotspot" aria-hidden="true"></div>
<div class="toast" id="toast">Saved! Returning to home…</div>

<div class="frame">
  <div class="sheet">
    <img src="logo.png" alt="CALIDUS Logo" class="logo" />

    <!-- HOME -->
    <div id="home" class="content section active">
      <h1 class="title">WELCOME TO <span class="blue">CALIDUS CONNECT</span></h1>
      <div class="intro"><p>Please choose one of the options below.</p></div>
      <div class="grid">
        <div class="tile" onclick="go('reg')">
          <h2>Register Your Interest <small id="countHomeReg">(0)</small></h2>
          <p>Leave your details and areas of interest for follow-up.</p>
          <span class="cta">Open Registration</span>
        </div>
        <div class="tile" onclick="go('meet')">
          <h2>Request a Meeting <small id="countHomeMeet">(0)</small></h2>
          <p>Select a preferred date/time, who to meet, and topics to discuss.</p>
          <span class="cta">Request Meeting</span>
        </div>
        <div class="tile" onclick="go('survey')">
          <h2>Exhibition Feedback <small id="countHomeSurvey">(0)</small></h2>
          <p>Rate our stand and team, and share suggestions.</p>
          <span class="cta">Start Survey</span>
        </div>
        <div class="tile" onclick="go('actions')">
          <h2>Action Items <small id="countHomeActions">(0)</small></h2>
          <p>Create and track tasks from meetings. Assign to cluster & person with due date.</p>
          <span class="cta">Open Actions</span>
        </div>
      </div>
    </div>

    <!-- REGISTRATION -->
    <div id="reg" class="content section">
      <h1 class="title">REGISTER <span class="blue">YOUR INTEREST</span></h1>
      <p class="intro">Please fill out the form below. One of our team members will get back to you.</p>
      <form id="regForm" autocomplete="on">
        <div class="grid2">
          <input name="company" placeholder="Company Name" required />
          <input list="countryList" name="country" placeholder="Country" />
          <input name="firstName" placeholder="First Name" required />
          <input name="lastName" placeholder="Last Name" required />
          <input name="title" placeholder="Title / Role" />
          <input name="phone" placeholder="Phone Number" inputmode="tel" />
          <input type="email" name="email" placeholder="Email Address" inputmode="email" required />
          <div class="row">
            <span>Are you a Supplier:</span>
            <label><input type="radio" name="supplier" value="Yes" required /> Yes</label>
            <label><input type="radio" name="supplier" value="No" /> No</label>
          </div>
        </div>
        <div class="row">
          <span>Which cluster(s) are you interested in:</span>
          <label><input type="checkbox" name="clusters" value="Aerospace" /> Aerospace</label>
          <label><input type="checkbox" name="clusters" value="Land Systems" /> Land</label>
          <label><input type="checkbox" name="clusters" value="Naval Systems" /> Naval</label>
          <label><input type="checkbox" name="clusters" value="Space Systems" /> Space</label>
          <label><input type="checkbox" name="clusters" value="Cyber Systems" /> Cyber</label>
        </div>
        <textarea name="notes" placeholder="Additional information or interest areas..."></textarea>
        <div class="row">
          <label><input type="checkbox" name="consent" required /> I consent to CALIDUS storing my details and contacting me.</label>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-ghost" onclick="go('home')">&larr; Back</button>
          <button type="button" class="btn btn-ghost" id="clearReg">Clear</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>

    <!-- MEETING -->
    <div id="meet" class="content section">
      <h1 class="title">REQUEST A <span class="blue">MEETING</span></h1>
      <p class="intro">Provide your details and preferred date/time. We’ll follow up to confirm.</p>
      <form id="meetForm" autocomplete="on">
        <div class="grid2">
          <input name="company" placeholder="Company Name" required />
          <input list="countryList" name="country" placeholder="Country" />
          <input name="firstName" placeholder="First Name" required />
          <input name="lastName" placeholder="Last Name" required />
          <input name="title" placeholder="Title / Role" />
          <input name="phone" placeholder="Phone Number" inputmode="tel" />
          <input type="email" name="email" placeholder="Email Address" inputmode="email" required />
          <input type="date" name="preferredDate" />
          <input type="time" name="preferredTime" />
          <select name="meetingWith" class="full">
            <option value="" selected disabled>Who would you like to meet?</option>
            <option>Senior Management</option>
            <option>Technical / Engineering</option>
            <option>Supply Chain & Procurement</option>
            <option>Business Development / Sales</option>
            <option>Program Management</option>
            <option>Media / Communications</option>
            <option>HR / Recruitment</option>
            <option>Other (specify in agenda)</option>
          </select>
          <select name="location" class="full">
            <option value="" selected disabled>Meeting Location</option>
            <option>On-site at CALIDUS booth</option>
            <option>Virtual</option>
            <option>Follow-up call</option>
          </select>
        </div>
        <div class="row">
          <span>Topic(s):</span>
          <label><input type="checkbox" name="topics" value="Aerospace" /> Aerospace</label>
          <label><input type="checkbox" name="topics" value="Land Systems" /> Land</label>
          <label><input type="checkbox" name="topics" value="Naval Systems" /> Naval</label>
          <label><input type="checkbox" name="topics" value="Space Systems" /> Space</label>
          <label><input type="checkbox" name="topics" value="Cyber Systems" /> Cyber</label>
        </div>
        <textarea name="agenda" placeholder="Agenda / discussion points..."></textarea>
        <div class="row">
          <label><input type="checkbox" name="consent" required /> I consent to CALIDUS storing my details and contacting me about this meeting.</label>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-ghost" onclick="go('home')">&larr; Back</button>
          <button type="button" class="btn btn-ghost" id="clearMeet">Clear</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>

      <!-- Meeting list w/ filters -->
      <div class="filters">
        <span class="muted">View:</span>
        <span class="pill active" data-meetfilter="all">All</span>
        <span class="pill" data-meetfilter="pending">Pending</span>
        <span class="pill" data-meetfilter="scheduled">Scheduled</span>
      </div>
      <div class="list" id="meetingList"></div>
    </div>

    <!-- SURVEY -->
    <div id="survey" class="content section">
      <h1 class="title">EXHIBITION <span class="blue">FEEDBACK SURVEY</span></h1>
      <p class="intro">Thanks for visiting our stand. Please share your feedback.</p>
      <form id="surveyForm" autocomplete="on">
        <div class="grid2">
          <input name="name" placeholder="Your Name" />
          <input name="company" placeholder="Company / Organization" />
          <input name="email" placeholder="Email Address" inputmode="email" />
          <select name="role">
            <option value="" selected disabled>Your Role / Visitor Type</option>
            <option>Government / Defense Official</option>
            <option>Industry Professional</option>
            <option>Media / Press</option>
            <option>General Visitor</option>
          </select>
        </div>
        <div class="row">
          <span>How did you hear about CALIDUS?</span>
          <label><input type="radio" name="source" value="Social Media" /> Social Media</label>
          <label><input type="radio" name="source" value="News / Media" /> News / Media</label>
          <label><input type="radio" name="source" value="Referral" /> Referral</label>
          <label><input type="radio" name="source" value="Exhibition Walk-in" /> Exhibition Walk-in</label>
        </div>
        <div class="row">
          <span>Which areas interested you most?</span>
          <label><input type="checkbox" name="interests" value="Aerospace" /> Aerospace</label>
          <label><input type="checkbox" name="interests" value="Land Systems" /> Land</label>
          <label><input type="checkbox" name="interests" value="Naval Systems" /> Naval</label>
          <label><input type="checkbox" name="interests" value="Space Systems" /> Space</label>
          <label><input type="checkbox" name="interests" value="Cyber Systems" /> Cyber</label>
        </div>
        <div class="row">
          <label>Staff Friendliness:
            <select name="staffRating"><option value="">--</option><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select>
          </label>
          <label>Stand Presentation:
            <select name="standRating"><option value="">--</option><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select>
          </label>
          <label>Product Knowledge:
            <select name="knowledgeRating"><option value="">--</option><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select>
          </label>
        </div>
        <textarea name="comments" placeholder="Additional comments or suggestions..."></textarea>
        <div class="row">
          <label><input type="checkbox" name="consent" required /> I consent to CALIDUS storing my feedback.</label>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-ghost" onclick="go('home')">&larr; Back</button>
          <button type="button" class="btn btn-ghost" id="clearSurvey">Clear</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>

    <!-- ACTION ITEMS -->
    <div id="actions" class="content section">
      <h1 class="title">MEETING <span class="blue">ACTION ITEMS</span></h1>
      <p class="intro">Capture tasks during/after meetings. Assign them to a cluster and a person, set due dates, and track completion.</p>

      <form id="actionForm" autocomplete="on">
        <div class="grid2">
          <input name="title" placeholder="Task title (what needs to be done?)" class="full" required />
          <select name="cluster">
            <option value="" selected disabled>Cluster</option>
            <option>Aerospace</option>
            <option>Land Systems</option>
            <option>Naval Systems</option>
            <option>Space Systems</option>
            <option>Cyber Systems</option>
          </select>
          <input name="assignee" placeholder="Assigned to (name / company)" />
          <input type="date" name="dueDate" />
        </div>
        <textarea name="notes" placeholder="Notes / context / next steps..."></textarea>
        <div class="actions">
          <button type="button" class="btn btn-ghost" onclick="go('home')">&larr; Back</button>
          <button type="button" class="btn btn-ghost" id="clearAction">Clear</button>
          <button type="submit" class="btn btn-primary">Add Action</button>
        </div>
      </form>

      <!-- Filters -->
      <div class="filters">
        <span class="muted">Status:</span>
        <span class="pill active" data-af="open">Open</span>
        <span class="pill" data-af="all">All</span>
        <span class="muted" style="margin-left:10px">Cluster:</span>
        <select id="actionClusterFilter">
          <option value="all">All</option>
          <option value="Aerospace">Aerospace</option>
          <option value="Land Systems">Land</option>
          <option value="Naval Systems">Naval</option>
          <option value="Space Systems">Space</option>
          <option value="Cyber Systems">Cyber</option>
        </select>
      </div>

      <!-- Live list -->
      <div class="list" id="actionList"></div>
    </div>

  </div>
</div>

<!-- Admin Overlay -->
<div id="admin" style="display:none">
  <div class="panel">
    <h2>Admin</h2>
    <p>Export or clear data captured on this device. Long-press top-right to open this menu.</p>
    <div class="admin-grid">
      <div class="admin-row">
        <div><strong>Registrations</strong> — total: <span id="countReg">0</span></div>
        <div class="admin-actions">
          <button class="btn btn-secondary" id="expRegCsv">Export CSV</button>
          <button class="btn btn-secondary" id="expRegJson">Export JSON</button>
          <button class="btn btn-secondary" id="clrReg">Clear</button>
        </div>
      </div>
      <div class="admin-row">
        <div><strong>Meetings</strong> — total: <span id="countMeet">0</span></div>
        <div class="admin-actions">
          <button class="btn btn-secondary" id="expMeetCsv">Export CSV</button>
          <button class="btn btn-secondary" id="expMeetJson">Export JSON</button>
          <button class="btn btn-secondary" id="clrMeet">Clear</button>
        </div>
      </div>
      <div class="admin-row">
        <div><strong>Surveys</strong> — total: <span id="countSurvey">0</span></div>
        <div class="admin-actions">
          <button class="btn btn-secondary" id="expSurveyCsv">Export CSV</button>
          <button class="btn btn-secondary" id="expSurveyJson">Export JSON</button>
          <button class="btn btn-secondary" id="clrSurvey">Clear</button>
        </div>
      </div>
      <div class="admin-row">
        <div><strong>Action Items</strong> — total: <span id="countActions">0</span></div>
        <div class="admin-actions">
          <button class="btn btn-secondary" id="expActCsv">Export CSV</button>
          <button class="btn btn-secondary" id="expActJson">Export JSON</button>
          <button class="btn btn-secondary" id="clrAct">Clear</button>
        </div>
      </div>
      <div class="admin-row">
        <div><strong>Export Everything</strong> — bundle (JSON)</div>
        <div class="admin-actions">
          <button class="btn btn-secondary" id="expAll">Export All</button>
        </div>
      </div>
      <div class="admin-row" style="justify-content:flex-end">
        <button class="btn btn-ghost" id="closeAdmin">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Common country list (short) -->
<datalist id="countryList">
  <option>United Arab Emirates</option><option>Saudi Arabia</option><option>Qatar</option>
  <option>Kuwait</option><option>Bahrain</option><option>Oman</option>
  <option>United States</option><option>United Kingdom</option><option>Germany</option>
  <option>France</option><option>Italy</option><option>Spain</option>
  <option>China</option><option>India</option><option>Japan</option><option>South Korea</option>
  <option>Australia</option><option>South Africa</option><option>Canada</option>
</datalist>

<script>
  // ============ UTILITIES ============
  const K_REG  = 'calidus_registration_v1';
  const K_MEET = 'calidus_meetings_v1';
  const K_SURV = 'calidus_survey_v1';
  const K_ACT  = 'calidus_actions_v1';
  const K_DEV  = 'calidus_device_id';

  // Device ID (for exports)
  if(!localStorage.getItem(K_DEV)){
    const id = (crypto.randomUUID && crypto.randomUUID()) || ('dev-' + Date.now());
    localStorage.setItem(K_DEV, id);
  }
  const deviceId = localStorage.getItem(K_DEV);

  const read  = (k)=>{ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]} };
  const write = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const esc   = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const dl    = (filename, text, type) => {
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  };
  const nowDate = ()=> new Date().toISOString().slice(0,10);

  function go(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
  }

  const toast = document.getElementById('toast');
  const chime = new (window.AudioContext||window.webkitAudioContext)();
  function beep(){ const o=chime.createOscillator(), g=chime.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(chime.destination); g.gain.setValueAtTime(0.0001,chime.currentTime); g.gain.exponentialRampToValueAtTime(0.1,chime.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,chime.currentTime+0.15); o.start(); o.stop(chime.currentTime+0.16); }
  function doneThenHome(){
    beep();
    toast.style.display='block';
    setTimeout(()=>{ toast.style.display='none'; go('home'); updateCounts(); }, 1200);
  }

  function updateCounts(){
    const cR = read(K_REG).length, cM = read(K_MEET).length, cS = read(K_SURV).length, cA = read(K_ACT).length;
    document.getElementById('countReg').textContent = cR;
    document.getElementById('countMeet').textContent = cM;
    document.getElementById('countSurvey').textContent = cS;
    document.getElementById('countActions').textContent = cA;
    document.getElementById('countHomeReg').textContent = `(${cR})`;
    document.getElementById('countHomeMeet').textContent = `(${cM})`;
    document.getElementById('countHomeSurvey').textContent = `(${cS})`;
    document.getElementById('countHomeActions').textContent = `(${cA})`;
    renderActions();
    renderMeetings();
  }

  // ============ REGISTRATION ============
  (function(){
    const form=document.getElementById('regForm');
    document.getElementById('clearReg').onclick=()=>form.reset();
    function getChecked(name){return [...form.querySelectorAll(`input[name="${name}"]:checked`)].map(x=>x.value)}
    function getRadio(name){const el=form.querySelector(`input[name="${name}"]:checked`);return el?el.value:''}
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const entry={
        deviceId,
        timestamp:new Date().toISOString(),
        company:fd.get('company')||'', country:fd.get('country')||'',
        firstName:fd.get('firstName')||'', lastName:fd.get('lastName')||'',
        title:fd.get('title')||'', phone:fd.get('phone')||'', email:fd.get('email')||'',
        supplier:getRadio('supplier'), clusters:getChecked('clusters'),
        notes:fd.get('notes')||'', consent: !!fd.get('consent')
      };
      const items=read(K_REG); items.push(entry); write(K_REG, items);
      form.reset(); doneThenHome();
    });
  })();

  // ============ MEETING (form + list) ============
  let meetingFilter='all';
  (function(){
    const form=document.getElementById('meetForm');
    document.getElementById('clearMeet').onclick=()=>form.reset();
    function getChecked(name){return [...form.querySelectorAll(`input[name="${name}"]:checked`)].map(x=>x.value)}
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const entry={
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        deviceId,
        timestamp:new Date().toISOString(),
        company:fd.get('company')||'', country:fd.get('country')||'',
        firstName:fd.get('firstName')||'', lastName:fd.get('lastName')||'',
        title:fd.get('title')||'', phone:fd.get('phone')||'', email:fd.get('email')||'',
        preferredDate:fd.get('preferredDate')||'', preferredTime:fd.get('preferredTime')||'',
        meetingWith:fd.get('meetingWith')||'', location:fd.get('location')||'',
        topics:getChecked('topics'),
        agenda:fd.get('agenda')||'',
        consent: !!fd.get('consent'),
        status:'Pending'
      };
      const items=read(K_MEET); items.push(entry); write(K_MEET, items);
      form.reset(); updateCounts(); doneThenHome();
    });

    // Filters
    document.querySelectorAll('[data-meetfilter]').forEach(p=>{
      p.addEventListener('click',()=>{
        document.querySelectorAll('[data-meetfilter]').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        meetingFilter = p.dataset.meetfilter;
        renderMeetings();
      });
    });
  })();

  function renderMeetings(){
    const list = document.getElementById('meetingList');
    let items = read(K_MEET);
    if(meetingFilter==='pending') items = items.filter(m=>m.status==='Pending');
    if(meetingFilter==='scheduled') items = items.filter(m=>m.status==='Scheduled');
    if(!items.length){ list.innerHTML='<div class="muted">No meeting requests yet.</div>'; return; }
    list.innerHTML = items.map((m,i)=>{
      const dt = (m.preferredDate||'') + (m.preferredTime?(' '+m.preferredTime):'');
      return `
        <div class="item">
          <div>
            <div><strong>${m.firstName||''} ${m.lastName||''}</strong> <small class="muted">(${m.company||'—'})</small></div>
            <small>${m.meetingWith||'—'} · ${m.location||'—'} ${dt?('· '+dt):''}</small>
          </div>
          <div><small class="muted">Topics</small><br>${(m.topics||[]).join(', ')||'—'}</div>
          <div><small class="muted">Country</small><br>${m.country||'—'}</div>
          <div><small class="muted">Email</small><br>${m.email||'—'}</div>
          <div><span class="badge ${m.status==='Scheduled'?'done':'pending'}">${m.status}</span></div>
          <div style="display:flex;gap:6px;justify-content:flex-end">
            ${m.status==='Scheduled' ? '' : `<button class="btn btn-ghost" data-meet="schedule" data-id="${m.id}">Mark Scheduled</button>`}
            <button class="btn btnDanger" data-meet="del" data-id="${m.id}">Delete</button>
          </div>
        </div>`;
    }).join('');
    list.querySelectorAll('button[data-meet]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id, action=btn.dataset.meet;
        const items=read(K_MEET);
        const idx=items.findIndex(x=>x.id===id);
        if(idx<0) return;
        if(action==='schedule'){ items[idx].status='Scheduled'; }
        if(action==='del'){ items.splice(idx,1); }
        write(K_MEET,items); renderMeetings(); updateCounts();
      });
    });
  }

  // ============ SURVEY ============
  (function(){
    const form=document.getElementById('surveyForm');
    document.getElementById('clearSurvey').onclick=()=>form.reset();
    function getChecked(name){return [...form.querySelectorAll(`input[name="${name}"]:checked`)].map(x=>x.value)}
    function getRadio(name){const el=form.querySelector(`input[name="${name}"]:checked`);return el?el.value:''}
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const entry={
        deviceId,
        timestamp:new Date().toISOString(),
        name:fd.get('name')||'', company:fd.get('company')||'', email:fd.get('email')||'',
        role:fd.get('role')||'', source:getRadio('source'), interests:getChecked('interests'),
        staffRating:fd.get('staffRating')||'', standRating:fd.get('standRating')||'', knowledgeRating:fd.get('knowledgeRating')||'',
        comments:fd.get('comments')||'', consent: !!fd.get('consent')
      };
      const items=read(K_SURV); items.push(entry); write(K_SURV, items);
      form.reset(); doneThenHome();
    });
  })();

  // ============ ACTION ITEMS ============
  let actionStatus='open';
  (function(){
    const form=document.getElementById('actionForm');
    const list=document.getElementById('actionList');
    const clusterSel = document.getElementById('actionClusterFilter');
    document.getElementById('clearAction').onclick=()=>form.reset();

    function render(){
      const filterCluster = clusterSel.value;
      let items = read(K_ACT);
      if(actionStatus==='open') items = items.filter(a=>a.status!=='Complete');
      if(filterCluster!=='all') items = items.filter(a=>a.cluster===filterCluster);
      if(!items.length){ list.innerHTML = '<div class="muted">No action items.</div>'; return; }

      const today = new Date(new Date().toDateString());
      const soonMs = 1000*60*60*24*2; // 2 days

      list.innerHTML = items.map((a,i)=>{
        const due = a.dueDate ? new Date(a.dueDate) : null;
        const dueMs = due ? (new Date(due.toDateString()) - today) : null;
        const overdue = due && (dueMs < 0) && a.status!=='Complete';
        const soon = due && (dueMs >= 0) && (dueMs <= soonMs) && a.status!=='Complete';
        const dueTxt = a.dueDate
              ? (overdue ? `<span class="danger">${a.dueDate}</span>`
                         : (soon ? `<span class="warn">${a.dueDate}</span>` : a.dueDate))
              : '<span class="muted">—</span>';
        return `
          <div class="item">
            <div>
              <div><strong>${a.title||''}</strong></div>
              <small>${a.notes?a.notes:'&nbsp;'}</small>
            </div>
            <div><small class="muted">Cluster</small><br>${a.cluster||'—'}</div>
            <div><small class="muted">Assignee</small><br>${a.assignee||'—'}</div>
            <div><small class="muted">Due</small><br>${dueTxt}</div>
            <div><span class="badge ${a.status==='Complete'?'done':'open'}">${a.status||'Open'}</span></div>
            <div style="display:flex;gap:6px;justify-content:flex-end">
              ${a.status==='Complete' ? '' : `<button class="btn btn-ghost" data-action="done" data-index="${i}">Complete</button>`}
              <button class="btn btnDanger" data-action="del" data-index="${i}">Delete</button>
            </div>
          </div>`;
      }).join('');

      list.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const idx=+btn.dataset.index, action=btn.dataset.action;
          const items=read(K_ACT);
          if(action==='done'){ items[idx].status='Complete'; }
          if(action==='del'){ items.splice(idx,1); }
          write(K_ACT, items); render(); updateCounts();
        });
      });
    }

    clusterSel.addEventListener('change', render);
    document.querySelectorAll('[data-af]').forEach(p=>{
      p.addEventListener('click',()=>{
        document.querySelectorAll('[data-af]').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        actionStatus = p.dataset.af;
        render();
      });
    });

    form.addEventListener('submit',(e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const entry = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        deviceId,
        timestamp: new Date().toISOString(),
        title: fd.get('title')||'',
        cluster: fd.get('cluster')||'',
        assignee: fd.get('assignee')||'',
        dueDate: fd.get('dueDate')||'',
        notes: fd.get('notes')||'',
        status: 'Open'
      };
      const items = read(K_ACT); items.push(entry); write(K_ACT, items);
      form.reset(); render(); updateCounts();
    });

    window.renderActions = render;
  })();

  function renderActions(){ /* defined above, kept here for linter */ }

  // ============ ADMIN (PIN + exports) ============
  (function(){
    const hotspot = document.getElementById('hotspot');
    const admin = document.getElementById('admin');
    const closeBtn = document.getElementById('closeAdmin');
    let timer;
    const start = ()=>{ 
      timer=setTimeout(()=>{ 
        const pin = prompt('Enter admin PIN:');
        if (pin === '1357') { admin.style.display='flex'; updateCounts(); }
        else if (pin !== null) alert('Incorrect PIN');
      },2000); 
    };
    const cancel = ()=> clearTimeout(timer);
    hotspot.addEventListener('mousedown', start);
    hotspot.addEventListener('touchstart', start, {passive:true});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>hotspot.addEventListener(ev, cancel));
    closeBtn.addEventListener('click', ()=> admin.style.display='none');

    // Registration exports
    document.getElementById('expRegCsv').onclick=()=>{
      const rows = read(K_REG); if(!rows.length) return alert('No registrations to export.');
      const headers=['deviceId','timestamp','company','country','firstName','lastName','title','phone','email','supplier','clusters','notes','consent'];
      const lines=[headers.join(',')];
      rows.forEach(r=>{
        const obj = {...r, clusters: Array.isArray(r.clusters) ? r.clusters.join('; ') : (r.clusters||'')};
        lines.push(headers.map(h=>esc(obj[h])).join(','));
      });
      dl(`calidus_registrations_${nowDate()}.csv`, lines.join('\r\n'), 'text/csv');
    };
    document.getElementById('expRegJson').onclick=()=>{
      const rows = read(K_REG); if(!rows.length) return alert('No registrations to export.');
      dl(`calidus_registrations_${nowDate()}.json`, JSON.stringify(rows, null, 2), 'application/json');
    };
    document.getElementById('clrReg').onclick=()=>{
      if(confirm('Clear ALL registrations on this device?')){ localStorage.removeItem(K_REG); updateCounts(); }
    };

    // Meeting exports
    document.getElementById('expMeetCsv').onclick=()=>{
      const rows = read(K_MEET); if(!rows.length) return alert('No meetings to export.');
      const headers=['deviceId','timestamp','company','country','firstName','lastName','title','phone','email','preferredDate','preferredTime','meetingWith','location','topics','agenda','consent','status'];
      const lines=[headers.join(',')];
      rows.forEach(r=>{
        const obj = {...r, topics: Array.isArray(r.topics) ? r.topics.join('; ') : (r.topics||'')};
        lines.push(headers.map(h=>esc(obj[h])).join(','));
      });
      dl(`calidus_meetings_${nowDate()}.csv`, lines.join('\r\n'), 'text/csv');
    };
    document.getElementById('expMeetJson').onclick=()=>{
      const rows = read(K_MEET); if(!rows.length) return alert('No meetings to export.');
      dl(`calidus_meetings_${nowDate()}.json`, JSON.stringify(rows, null, 2), 'application/json');
    };
    document.getElementById('clrMeet').onclick=()=>{
      if(confirm('Clear ALL meetings on this device?')){ localStorage.removeItem(K_MEET); updateCounts(); }
    };

    // Survey exports
    document.getElementById('expSurveyCsv').onclick=()=>{
      const rows = read(K_SURV); if(!rows.length) return alert('No surveys to export.');
      const headers=['deviceId','timestamp','name','company','email','role','source','interests','staffRating','standRating','knowledgeRating','comments','consent'];
      const lines=[headers.join(',')];
      rows.forEach(r=>{
        const obj = {...r, interests: Array.isArray(r.interests) ? r.interests.join('; ') : (r.interests||'')};
        lines.push(headers.map(h=>esc(obj[h])).join(','));
      });
      dl(`calidus_surveys_${nowDate()}.csv`, lines.join('\r\n'), 'text/csv');
    };
    document.getElementById('expSurveyJson').onclick=()=>{
      const rows = read(K_SURV); if(!rows.length) return alert('No surveys to export.');
      dl(`calidus_surveys_${nowDate()}.json`, JSON.stringify(rows, null, 2), 'application/json');
    };
    document.getElementById('clrSurvey').onclick=()=>{
      if(confirm('Clear ALL surveys on this device?')){ localStorage.removeItem(K_SURV); updateCounts(); }
    };

    // Action Items exports
    document.getElementById('expActCsv').onclick=()=>{
      const rows = read(K_ACT); if(!rows.length) return alert('No action items to export.');
      const headers=['deviceId','timestamp','title','cluster','assignee','dueDate','status','notes'];
      const lines=[headers.join(',')];
      rows.forEach(r=>{ lines.push(headers.map(h=>esc(r[h])).join(',')); });
      dl(`calidus_actions_${nowDate()}.csv`, lines.join('\r\n'), 'text/csv');
    };
    document.getElementById('expActJson').onclick=()=>{
      const rows = read(K_ACT); if(!rows.length) return alert('No action items to export.');
      dl(`calidus_actions_${nowDate()}.json`, JSON.stringify(rows, null, 2), 'application/json');
    };
    document.getElementById('clrAct').onclick=()=>{
      if(confirm('Clear ALL action items on this device?')){ localStorage.removeItem(K_ACT); updateCounts(); }
    };

    // Export All
    document.getElementById('expAll').onclick=()=>{
      const bundle = {
        deviceId,
        exportedAt: new Date().toISOString(),
        registrations: read(K_REG),
        meetings:      read(K_MEET),
        surveys:       read(K_SURV),
        actions:       read(K_ACT)
      };
      if (!bundle.registrations.length && !bundle.meetings.length && !bundle.surveys.length && !bundle.actions.length){
        return alert('No data to export.');
      }
      dl(`calidus_all_${nowDate()}.json`, JSON.stringify(bundle, null, 2), 'application/json');
    };
  })();

  // ============ INACTIVITY AUTO-RESET ============
  (function(){
    const TIMEOUT_MS = 60000; // 60s
    let t;
    const reset = ()=>{
      clearTimeout(t);
      t = setTimeout(()=> {
        go('home');
        if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
      }, TIMEOUT_MS);
    };
    ['click','touchstart','keydown','mousemove','scroll'].forEach(ev =>
      document.addEventListener(ev, reset, {passive:true})
    );
    reset();
  })();

  // Initial render
  updateCounts();
</script>
</body>
</html>
